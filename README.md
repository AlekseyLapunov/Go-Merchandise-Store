# Merchandise store

Сервис "Магазин мерча" разработан по методологии Domain Driven Design. Исходный код доступен в каталоге `src`.

# Запуск приложения

Собрать и запустить приложение можно с помощью `docker compose`:

```bash
$ docker compose up --build
```

Остановить `docker compose`:

```bash
$ docker compose down -v
```

После того, как в логах появится запись о том, что сервис готов принимать запросы, к приложению можно обращаться извне.

# Тестирование

Проект содержит модульные и e2e-тесты.

## Информация о написанных E2E тестах

Исходный код тестов находится в директории `e2e`.

Описанные тест-кейсы:
- покупка мерча: проверяется начальный баланс, приобретается несколько предметов и проверяется корректное изменение баланса;
- покупка мерча: проверяется передача неправильного JWT-токена и ожидание ответа `Unauthorized`;
- покупка мерча: попытка купить много дорогих предметов, ожидание ответа "недостаточно монеток" (`Bad request`);
- покупка мерча: покупка нескольких предметов (разного вида) в разном количестве, проверяются купленные предметы и оставшееся количество монеток;
- передача монеток: проверяется начальный баланс, два сотрудника передают друг другу монетки и затем проверяется корректное изменение баланса обоих участников;
- передача монеток: три участника обмениваются монетками между собой, проверяется история обмена;
- передача монеток: два участника пытаются передать друг другу количество монет, превышающее их текущий баланс, проверяется ожидаемый ответ "недостаточно монеток" (`Bad request`).

Как запустить E2E тесты описано далее в соответствующем разделе.

## Покрытие проекта модульными тестами

Модульное тестирование выполнено с использованием мокирования.

Вывод команды `go test ./... -cover` в каталоге исходного кода `src` следующий:

```
?   <snap>src/entity     [no test files]
    <snap>src                            coverage: 0.0% of statements
ok  <snap>src/handler    (cached)        coverage: 69.0% of statements
ok  <snap>src/middleware (cached)        coverage: 44.7% of statements
    <snap>src/mockery                    coverage: 0.0% of statements
ok  <snap>src/storage    (cached)        coverage: 63.5% of statements
ok  <snap>src/usecase    (cached)        coverage: 68.4% of statements
```

Слой `entity` не нуждается в тестах, так содержит только структуры. Пакет `mockery` также не нужно тестировать, так как в нём представлены моки объектов из слоёв `usecase` и `storage`.

Таким образом, если брать в расчёт только тестирование слоёв `handler`, `middleware`, `usecase` и `storage`, то среднее тестовое покрытие составляет `61,4%`.

## Запуск тестов

### Юнит-тесты

Запустить модульные тесты с выводом процента покрытия по модулям:

```bash
$ cd src

$ go test ./... -cover
```

### E2E-тесты

Для запуска E2E тестов необходимо установить переменную окружения `RUN_E2E` в значение `true` перед запуском `docker compose`.

# Прочие вопросы и решение

Во время разработки появился вопрос: "Может-ли сотрудник отправлять монетки самому себе?" (например, сотрудник `employee` вызывает метод `/api/sendCoin`, в теле запроса указывая при этом себя как получателя).

В требованиях нет запрета на такое действие в явном виде, однако я решил запретить подобное использование метода, так как это бессмыссленное действие, которое, причём, может сильно нагрузить приложение и БД при многократном использовании за короткий промежуток времени.

Итог: сейчас, при попытке сотрудника отправить монетки самому себе, выдаётся ошибка `400 Bad request` с соответствующим сообщением:
```json
{
  "error": "can't send coins to yourself"
}
```
